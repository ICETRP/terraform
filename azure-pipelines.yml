trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # ←←← CHANGE ONLY THIS LINE TO YOUR REAL STORAGE ACCOUNT NAME ←←←
  storageAccountName: 'tfstate12345'   # ← e.g. tfstate73829, tfstateabc123, etc.

steps:
# 1. Install Terraform (official way – works 100%)
- bash: |
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg >/dev/null
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt update && sudo apt install terraform -y
  displayName: 'Install Terraform'

# 2. Show version (optional but nice)
- bash: terraform version
  displayName: 'Terraform Version'

# 3. Terraform Init – uses your service connection + remote state
- bash: |
    terraform init \
      -backend-config="resource_group_name=tf-win-rg" \
      -backend-config="storage_account_name=$(storageAccountName)" \
      -backend-config="container_name=tfstate" \
      -backend-config="key=azure-vm.tfstate"
  displayName: 'Terraform Init'
  env:
    ARM_SAS_TOKEN: $(azure-terraform-sp)   # ← clean, secure, no warnings

# 4. Terraform Plan – see exactly what will be created/changed
- bash: terraform plan -out=tfplan -detailed-exitcode
  displayName: 'Terraform Plan'
  continueOnError: true   # allows plan to pass even if changes exist
  env:
    ARM_SAS_TOKEN: $(azure-terraform-sp)

# 5. Terraform Apply – creates or updates your VM automatically
- bash: terraform apply -auto-approve tfplan
  displayName: 'Terraform Apply → Creates/Udates Ubuntu VM'
  condition: succeeded()
  env:
    ARM_SAS_TOKEN: $(azure-terraform-sp)

# 6. Output the public IP (visible in pipeline logs)
- bash: |
    echo "Ubuntu VM Public IP:"
    terraform output -raw public_ip || echo "No changes"
  displayName: 'Show VM Public IP'
  env:
    ARM_SAS_TOKEN: $(azure-terraform-sp)