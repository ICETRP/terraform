trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  storageAccountName: 'YOUR-STORAGE-ACCOUNT-NAME'  # e.g., tfstate73829 – CHANGE THIS!

steps:
# Step 1: Install Terraform (no extension needed)
- script: |
    # Install Chocolatey (package manager)
    curl -fsSL https://getchocolatey.org/install.ps1 | powershell -ExecutionPolicy ByPass
    # Install Terraform latest
    choco install terraform -y
    # Add to PATH
    echo "##vso[task.prependpath]$env:ChocolateyInstall/bin"
  displayName: 'Install Terraform'

# Step 2: Terraform Init with remote state (uses service connection for auth)
- script: |
    terraform init \
      -backend-config="resource_group_name=tf-win-rg" \
      -backend-config="storage_account_name=$(storageAccountName)" \
      -backend-config="container_name=tfstate" \
      -backend-config="key=azure-vm.tfstate"
  displayName: 'Terraform Init'
  env:
    ARM_SUBSCRIPTION_ID: $(azure-terraform-sp.subscriptionId)
    ARM_CLIENT_ID: $(azure-terraform-sp.clientId)
    ARM_CLIENT_SECRET: $(azure-terraform-sp.clientSecret)
    ARM_TENANT_ID: $(azure-terraform-sp.tenantId)

# Step 3: Terraform Plan
- script: terraform plan -out=tfplan
  displayName: 'Terraform Plan'
  env:
    ARM_SUBSCRIPTION_ID: $(azure-terraform-sp.subscriptionId)
    ARM_CLIENT_ID: $(azure-terraform-sp.clientId)
    ARM_CLIENT_SECRET: $(azure-terraform-sp.clientSecret)
    ARM_TENANT_ID: $(azure-terraform-sp.tenantId)

# Step 4: Publish plan as artifact (for manual review if needed)
- publish: tfplan
  artifact: plan-artifact
  displayName: 'Publish Plan Artifact'

# Step 5: Terraform Apply (only on main branch – auto-approve)
- script: terraform apply -auto-approve tfplan
  displayName: 'Terraform Apply'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  env:
    ARM_SUBSCRIPTION_ID: $(azure-terraform-sp.subscriptionId)
    ARM_CLIENT_ID: $(azure-terraform-sp.clientId)
    ARM_CLIENT_SECRET: $(azure-terraform-sp.clientSecret)
    ARM_TENANT_ID: $(azure-terraform-sp.tenantId)