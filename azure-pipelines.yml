# azure-pipelines.yml
trigger:
  branches:
    include:
      - main
      - master

variables:
  - name: subscriptionId
    value: 'f18cee0c-94ae-4dd3-ac8a-a6fd1e37b163'
  - name: tenantId
    value: 'c872c2b0-012f-4d75-a07b-7a6fd47d6066'
  - name: location
    value: 'eastus'
  - name: resourceGroupName
    value: 'ubuntu-vm-rg'
  - name: vmName
    value: 'ubuntu-vm'
  - name: vmSize
    value: 'Standard_B2s'

stages:
- stage: DeployUbuntuVM
  displayName: 'Deploy Ubuntu VM'
  jobs:
  - job: Deploy
    displayName: 'Deploy Ubuntu 22.04 VM'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    # Step 1: Checkout code
    - checkout: self
      displayName: 'Checkout Code'
    
    # Step 2: Install Terraform
    - task: TerraformInstaller@1
      displayName: 'Install Terraform 1.9.0'
      inputs:
        terraformVersion: '1.9.0'
    
    # Step 3: Azure CLI Login
    - task: AzureCLI@2
      displayName: 'Azure CLI Login'
      inputs:
        azureSubscription: 'Azure Connection'  # Will create in next step
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "======================================="
          echo "Azure Login Successful"
          echo "Subscription: $(subscriptionId)"
          echo "Tenant: $(tenantId)"
          echo "======================================="
          
          az account show
          
          # Set environment variables for Terraform
          echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(subscriptionId)"
          echo "##vso[task.setvariable variable=ARM_TENANT_ID]$(tenantId)"
    
    # Step 4: Terraform Initialize
    - task: TerraformTaskV4@4
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        commandOptions: '-upgrade'
    
    # Step 5: Terraform Plan
    - task: TerraformTaskV4@4
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        environmentServiceNameAzureRM: 'Azure Connection'
        commandOptions: |
          -var="subscription_id=$(subscriptionId)"
          -var="tenant_id=$(tenantId)"
          -var="resource_group_name=$(resourceGroupName)"
          -var="location=$(location)"
          -var="vm_name=$(vmName)"
          -var="vm_size=$(vmSize)"
          -out=tfplan
    
    # Step 6: Terraform Apply
    - task: TerraformTaskV4@4
      displayName: 'Terraform Apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        environmentServiceNameAzureRM: 'Azure Connection'
        commandOptions: |
          -auto-approve
          -var="subscription_id=$(subscriptionId)"
          -var="tenant_id=$(tenantId)"
          -var="resource_group_name=$(resourceGroupName)"
          -var="location=$(location)"
          -var="vm_name=$(vmName)"
          -var="vm_size=$(vmSize)"
    
    # Step 7: Get Terraform Outputs
    - task: TerraformTaskV4@4
      displayName: 'Terraform Output'
      inputs:
        provider: 'azurerm'
        command: 'output'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        environmentServiceNameAzureRM: 'Azure Connection'
    
    # Step 8: Save SSH Key as Pipeline Artifact
    - task: CopyFiles@2
      displayName: 'Copy SSH Key'
      inputs:
        Contents: 'azure-key.pem'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        CleanTargetFolder: true
        OverWrite: true
    
    - task: PublishPipelineArtifact@1
      displayName: 'Publish SSH Key Artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'ssh-key'
        publishLocation: 'pipeline'
    
    # Step 9: Display Connection Information
    - task: Bash@3
      displayName: 'Display VM Connection Details'
      inputs:
        targetType: 'inline'
        script: |
          echo "=============================================="
          echo "üöÄ UBUNTU VM DEPLOYMENT COMPLETE!"
          echo "=============================================="
          echo ""
          echo "üìã VM DETAILS:"
          echo "   ‚Ä¢ VM Name: $(vmName)"
          echo "   ‚Ä¢ Resource Group: $(resourceGroupName)"
          echo "   ‚Ä¢ Location: $(location)"
          echo "   ‚Ä¢ VM Size: $(vmSize)"
          echo ""
          echo "üîó CONNECTION INSTRUCTIONS:"
          echo "   1. SSH Key downloaded as pipeline artifact"
          echo "   2. SSH Command:"
          echo "      ssh -i azure-key.pem azureuser@[PUBLIC_IP]"
          echo ""
          echo "üì° SERVICES INSTALLED:"
          echo "   ‚Ä¢ Nginx web server (port 80)"
          echo ""
          echo "‚ö†Ô∏è  SECURITY NOTES:"
          echo "   ‚Ä¢ SSH key is stored in pipeline artifacts"
          echo "   ‚Ä¢ SSH port 22 is open to all IPs"
          echo "   ‚Ä¢ Change NSG rules for production use"
          echo "=============================================="
    
    # Step 10: Test SSH Connection (Optional)
    - task: Bash@3
      displayName: 'Test SSH Connection (Optional)'
      inputs:
        targetType: 'inline'
        script: |
          echo "Testing if SSH key was generated..."
          if [ -f "azure-key.pem" ]; then
            echo "‚úÖ SSH key found at: $(pwd)/azure-key.pem"
            chmod 600 azure-key.pem
            echo "‚úÖ SSH key permissions set to 600"
          else
            echo "‚ùå SSH key not found!"
          fi
      enabled: false  # Set to true to enable SSH test