# azure-pipelines.yml - SIMPLEST WORKING VERSION
trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
# Step 1: Checkout
- checkout: self

# Step 2: Install Tools
- script: |
    # Install Terraform
    wget https://releases.hashicorp.com/terraform/1.9.0/terraform_1.9.0_linux_amd64.zip
    unzip terraform_1.9.0_linux_amd64.zip
    sudo mv terraform /usr/local/bin/
    
    # Install Azure CLI
    curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
  displayName: 'Install Tools'

# Step 3: Login to Azure - SIMPLIFIED
- task: AzureCLI@2
  inputs:
    azureSubscription: 'Azure Connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: 'az account show'
  displayName: 'Azure Login'

# Step 4: Run Terraform
- script: |
    terraform init
    terraform plan
    terraform apply -auto-approve
  displayName: 'Run Terraform'
  env:
    ARM_SUBSCRIPTION_ID: 'f18cee0c-94ae-4dd3-ac8a-a6fd1e37b163'
    ARM_TENANT_ID: 'c872c2b0-012f-4d75-a07b-7a6fd47d6066'

# Step 5: Show Results
- script: |
    echo "=== DEPLOYMENT COMPLETE ==="
    echo "Public IP: $(terraform output -raw public_ip_address 2>/dev/null || echo 'Check terraform output')"
    echo "SSH Command: ssh -i azure-key.pem azureuser@$(terraform output -raw public_ip_address 2>/dev/null || echo 'IP_NOT_FOUND')"
  displayName: 'Show Results'