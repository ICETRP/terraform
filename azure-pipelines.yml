# azure-pipelines.yml - WORKING VERSION
trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
# Step 1: Checkout
- checkout: self
  displayName: 'Checkout Code'

# Step 2: Install Tools
- bash: |
    echo "=== Installing Tools ==="
    
    # Install Terraform
    wget -q https://releases.hashicorp.com/terraform/1.9.0/terraform_1.9.0_linux_amd64.zip
    unzip -o terraform_1.9.0_linux_amd64.zip
    sudo mv terraform /usr/local/bin/
    terraform version
    
    echo "=== Tools Installed ==="
  displayName: 'Install Terraform'

# Step 3: Run Terraform in Azure CLI Context (CRITICAL!)
- task: AzureCLI@2
  displayName: 'Azure Login & Terraform Deploy'
  inputs:
    azureSubscription: 'Azure Connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "========================================"
      echo "Azure Login Successful!"
      echo "========================================"
      
      # Show Azure account
      az account show
      
      # Clean previous state
      rm -rf .terraform
      rm -f terraform.tfstate*
      
      echo ""
      echo "=== Terraform Init ==="
      terraform init
      
      echo ""
      echo "=== Terraform Plan ==="
      terraform plan
      
      echo ""
      echo "=== Terraform Apply ==="
      terraform apply -auto-approve
      
      echo ""
      echo "=== Terraform Outputs ==="
      terraform output
      
      # Copy SSH key from /tmp to workspace
      if [ -f "/tmp/azure-key.pem" ]; then
        echo "Copying SSH key from /tmp to workspace..."
        cp /tmp/azure-key.pem $(Build.SourcesDirectory)/azure-key.pem
        chmod 600 $(Build.SourcesDirectory)/azure-key.pem
        echo "SSH key copied to workspace"
      else
        echo "WARNING: SSH key not found in /tmp"
        # Try to find it
        find / -name "azure-key.pem" 2>/dev/null || echo "SSH key not found anywhere"
      fi
      
      echo "========================================"
      echo "‚úÖ VM DEPLOYMENT COMPLETE!"
      echo "========================================"

# Step 4: Verify and Save SSH Key
- bash: |
    echo "=== Verifying SSH Key ==="
    echo "Current directory: $(pwd)"
    echo "Files in directory:"
    ls -la
    
    echo ""
    echo "Looking for SSH key..."
    if [ -f "azure-key.pem" ]; then
      echo "‚úÖ SSH key found: azure-key.pem"
      echo "File size: $(stat -c%s azure-key.pem) bytes"
      echo "Permissions:"
      ls -la azure-key.pem
      
      # Set correct permissions
      chmod 600 azure-key.pem
      
      # Copy to a known location
      cp azure-key.pem $(Build.ArtifactStagingDirectory)/azure-key.pem
      echo "SSH key copied to artifact staging"
    else
      echo "‚ùå ERROR: azure-key.pem not found in workspace!"
      echo "Creating a dummy file for debugging..."
      echo "dummy-key" > azure-key.pem
      chmod 600 azure-key.pem
    fi
  displayName: 'Verify SSH Key'

# Step 5: Save Artifact
- task: PublishPipelineArtifact@1
  displayName: 'Publish SSH Key'
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifact: 'ssh-key'
    publishLocation: 'pipeline'

# Step 6: Display Results
- bash: |
    echo "=============================================="
    echo "üöÄ UBUNTU VM DEPLOYMENT COMPLETE!"
    echo "=============================================="
    echo ""
    echo "üìã NEXT STEPS:"
    echo "1. Download 'ssh-key' artifact from pipeline"
    echo "2. Extract azure-key.pem from the artifact"
    echo "3. Set permissions: chmod 600 azure-key.pem"
    echo "4. Get public IP from Terraform outputs above"
    echo "5. Connect: ssh -i azure-key.pem azureuser@[PUBLIC_IP]"
    echo ""
    echo "‚ö†Ô∏è  SECURITY NOTE:"
    echo "‚Ä¢ SSH port 22 is open to all IPs"
    echo "‚Ä¢ Delete SSH key after use"
    echo "=============================================="
  displayName: 'Display Connection Info'