trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  storageAccountName: 'tfstate73829'   # ← YOUR EXACT STORAGE ACCOUNT NAME

stages:
- stage: Terraform
  displayName: 'Terraform: Init, Plan, Apply'
  jobs:
  - job: TerraformJob
    steps:
    # Install Terraform (extension task)
    - task: charleszipp.azure-pipelines-tasks-terraform.TerraformInstaller@0
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    # Init with remote state – auth via service connection
    - task: charleszipp.azure-pipelines-tasks-terraform.TerraformTaskV1@0
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        backendType: 'azurerm'
        backendServiceArm: 'azure-terraform-sp'  # Your service connection
        backendAzureRmResourceGroupName: 'tf-win-rg'
        backendAzureRmStorageAccountName: '$(storageAccountName)'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'azure-vm.tfstate'

    # Plan – auth via service connection
    - task: charleszipp.azure-pipelines-tasks-terraform.TerraformTaskV1@0
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        environmentServiceNameAzureRm: 'azure-terraform-sp'
        commandOptions: '-out=tfplan'

    # Apply – auth via service connection
    - task: charleszipp.azure-pipelines-tasks-terraform.TerraformTaskV1@0
      displayName: 'Terraform Apply – Creates Ubuntu VM'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        environmentServiceNameAzureRm: 'azure-terraform-sp'
        commandOptions: '-auto-approve tfplan'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

    # Show outputs
    - bash: |
        echo "SUCCESS! VM CREATED/UPDATED"
        terraform output -raw public_ip || echo "Check Azure portal for IP"
        terraform output ssh_command || echo "SSH: ssh -i azure-key.pem azureuser@<IP>"
      displayName: 'Show VM Public IP & SSH Command'
      condition: succeeded()